# Memory Benchmark

The `MemoryBenchmark.ino` was compiled with each `FEATURE_*` and the flash
memory and static RAM sizes were recorded. The `FEATURE_BASELINE` selection is
the baseline, and its memory usage  numbers are subtracted from the subsequent
`FEATURE_*` memory usage.

**Version**: AceTime v1.7.5

**DO NOT EDIT**: This file was auto-generated using `make README.md`.

## How to Regenerate

To regenerate this README.md:

```
$ make clean_benchmarks
$ make benchmarks
$ make README.md
```

The `make benchmarks` target uses `collect.sh` script which calls `auniter.sh`
(https://github.com/bxparks/AUniter) to invoke the Arduino IDE programmatically.
It produces a `*.txt` file with the flash and ram usage information (e.g.
`nano.txt`). It now takes about 16 minutes to generate the `*.txt` files on my
quad-core Intel Core i7-3840QM CPU @ 2.80GHz laptop.

The `make README.md` command calls the `generated_readme.py` Python script which
generates this `README.md` file. The ASCII tables below are generated by the
`generate_table.awk` script, which takes each `*.txt` file and converts it to an
ASCII table.

## Library Size Changes

In v1.3:
* The `BasicZoneManager` and `ExtendedZoneManager` classes were unified under a
  new parent interface `ZoneManager`. This seems to have caused the flash size
  to increase by around 1200 bytes on the AVR processors (Nano, Pro Micro),
  about 500 bytes on a SAMD, about 800 bytes on a ESP8266, 100 bytes on a ESP32,
  and 1400 bytes on a Teensy 3.2. The 8-bit processors suffer the most flash
  size increase proportional to their limited 32kB limit.
* Adding the `ZoneManager` interface simplifies a lot of the complexity with
  saving and restoring time zones using the `TimeZoneData` object, and I think
  it is worth the extra cost of flash size. The mitigating factor is that
  applications targetted towards 8-bit processors will normally have fixed
  number of timezones at compile time, so they can avoid using a `ZoneManager`,
  and avoid this penalty in flash size.

In v1.4.1+:
* Removed the `ZoneInfo::transitionBufSize` field from the `ZoneInfo` struct,
  which saves 1 byte on 8-bit processors (none on 32-bit processors due to
  4-byte alignment). We save 266 bytes for `BasicZoneManager` and 386 bytes for
  `ExtendedZoneManager` when all the zones are loaded into the zone registry.
* Incorporated zoneName compression causes flash/ram usage to increase by
  ~250/120 bytes when using only 1-2 zones, but *decreases* flash consumption by
  1200-2400 bytes when all the zones are loaded into the `ZoneManager`.

In v1.5+:
* Changing `ZoneProcessorCache::getType()` from a `virtual` to a non-virtual
  method saves 250-350 bytes of flash memory when using a `BasicZoneManager` or
  an `ExtendedZoneManager` on an 8-bit AVR processor. Unexpectedly, the flash
  memory consumption *increases* slightly (~0-50 bytes) for some ARM processors
  and the ESP32. Since those processors have far more flash memory, this seems
  like a good tradeoff.
* Changing `BasicZoneProcessor` and `ExtendedZoneProcessor` to be subclasses of
  the templatized `BasicZoneProcessorTemplate` and
  `ExtendedZoneProcessorTemplate` classes causes reduction of flash consumption
  by 250-400 bytes for 32-bit processors. Don't know why. (Very little
  difference for 8-bit AVR).
* Adding a `BrokerFactory` layer of indirection (to support more complex
  ZoneProcessors and Brokers) causes flash memory to go up by 100-200 bytes.

In v1.6:
* Added support for `LinkRegistry` to `BasicZoneManager` and
  `ExtendedZoneManager`. This increases the flash memory usage by 150-500 bytes
  when using one of these classes due to the code required by `LinkRegistrar`.
  This extra cost is incurred even if the `LinkRegistry` is set to 0 elements.
  Each `LinkEntry` consumes 8 bytes (2 x `uint32_t`). So a
  `zonedb::kLinkRegistry` with 183 elements uses 1464 extra bytes of flash; a
  `zonedbx::kLinkRegistry` with 207 elements uses 1656 extra bytes.

In v1.7:
* The virtual destructor on the `Clock` base class removed. This reduced the
  flash usage by 618 bytes on AVR processors , 328 bytes on the SAMD21, but only
  50-60 bytes on other 32-bit processors.
* The various `printShortNameTo()` or `printShortTo()` methods changed to
  replace the underscore in the zone names (e.g. `Los_Angeles`) with spaces
  (e.g. `Los Angeles`) to be more human friendly. This made little difference in
  the flash memory consumption, except on the ESP32 where it increased by
  200-300 bytes.

In v1.7.2
* The `SystemClock::clockMillis()` is now non-virtual, using compile-time
  polymorphism through C++ template, and incorporating the same techniques from
  AceRoutine v1.3. Saves about 20-40 bytes of flash.

In v1.7.5:
* `ExtendedZoneProcessor.compareTransitionToMatch()` was modified to
  detect an exact equality between a `Transition` and its `MatchingEra` if any
  of the 3 time stamp versions ('w', 's', 'u') are equal. Adds about 120-150
  bytes of flash on 8-bit and 32-bit processors. But removing
  `originalTransitionTime` from `Transition` decreases flash usage by about 20
  bytes.
* Upgrade ESP8266 Core from 2.7.4 to 3.0.2. Flash consumption increases by
  3-5 kB across the board.
* Upgrade Teensyduino from 1.54 to 1.55. Add memory consumed by `malloc()` and
  `free()` when using classes with virtual methods into baseline
  MemoryBenchmark, reducing the actual memory usage of various features by
  ~3kB.

In v1.7.5+:
* Convert `DS3231.h` into a template class for `<AceWire.h>`, replacing direct
  dependency on `<Wire.h>`.
    * Just including the `<Wire.h>` header causes flash memory to be consumed,
      even if `Wire` object is never used.
    * Saves 1000-1500 bytes of flash on AVR processors.
    * Saves 500 bytes of flash on SAMD.
    * Saves 4000 bytes of flash STM32.
    * Saves 500 bytes of flash on ESP8266.
    * Saves 3000-4000 bytes of flash on ESP32.
    * Saves 2500 bytes of flash on Teensy 3.2.

## Arduino Nano

* 16MHz ATmega328P
* Arduino IDE 1.8.16, Arduino CLI 0.19.2
* Arduino AVR Boards 1.8.3

```
+---------------------------------------------------------------------+
| Functionality                          |  flash/  ram |       delta |
|----------------------------------------+--------------+-------------|
| Baseline                               |    474/   11 |     0/    0 |
|----------------------------------------+--------------+-------------|
| LocalDateTime                          |    820/   13 |   346/    2 |
| ZonedDateTime                          |   1302/   13 |   828/    2 |
| Manual ZoneManager                     |   1546/   13 |  1072/    2 |
| Basic TimeZone (1 zone)                |   6174/  199 |  5700/  188 |
| Basic TimeZone (2 zones)               |   6678/  203 |  6204/  192 |
| BasicZoneManager (1 zone)              |   7900/  219 |  7426/  208 |
| BasicZoneManager (zones)               |  20594/  595 | 20120/  584 |
| BasicZoneManager (zones+thin links)    |  22208/  595 | 21734/  584 |
| BasicZoneManager (zones+fat links)     |  24922/  595 | 24448/  584 |
| Extended TimeZone (1 zone)             |   9182/  233 |  8708/  222 |
| Extended TimeZone (2 zones)            |   9826/  237 |  9352/  226 |
| ExtendedZoneManager (1 zone)           |  10868/  253 | 10394/  242 |
| ExtendedZoneManager (zones)            |  32604/  737 | 32130/  726 |
| ExtendedZoneManager (zones+thin links) |  34406/  737 | 33932/  726 |
| ExtendedZoneManager (zones+fat links)  |  37484/  737 | 37010/  726 |
|----------------------------------------+--------------+-------------|
| SystemClock                            |   5120/  263 |  4646/  252 |
| SystemClock+Basic TimeZone             |   9908/  437 |  9434/  426 |
| SystemClock+Extended TimeZone          |  12964/  471 | 12490/  460 |
+---------------------------------------------------------------------+

```

## Sparkfun Pro Micro

* 16 MHz ATmega32U4
* Arduino IDE 1.8.16, Arduino CLI 0.19.2
>>>>>>> MemoryBenchmark: Regenerate after replacing direct dependency on <Wire.h> with <AceWire.h>; saves 500-4000 bytes of flash
* SparkFun AVR Boards 1.1.13

```
+---------------------------------------------------------------------+
| Functionality                          |  flash/  ram |       delta |
|----------------------------------------+--------------+-------------|
| Baseline                               |   3470/  153 |     0/    0 |
|----------------------------------------+--------------+-------------|
| LocalDateTime                          |   3814/  153 |   344/    0 |
| ZonedDateTime                          |   4296/  153 |   826/    0 |
| Manual ZoneManager                     |   4540/  153 |  1070/    0 |
| Basic TimeZone (1 zone)                |   9166/  337 |  5696/  184 |
| Basic TimeZone (2 zones)               |   9672/  343 |  6202/  190 |
| BasicZoneManager (1 zone)              |  10892/  357 |  7422/  204 |
| BasicZoneManager (zones)               |  23588/  735 | 20118/  582 |
| BasicZoneManager (zones+thin links)    |  25202/  735 | 21732/  582 |
| BasicZoneManager (zones+fat links)     |  27916/  735 | 24446/  582 |
| Extended TimeZone (1 zone)             |  12174/  371 |  8704/  218 |
| Extended TimeZone (2 zones)            |  12820/  377 |  9350/  224 |
| ExtendedZoneManager (1 zone)           |  13860/  391 | 10390/  238 |
| ExtendedZoneManager (zones)            |  35596/  875 | 32126/  722 |
| ExtendedZoneManager (zones+thin links) |  37398/  875 | 33928/  722 |
| ExtendedZoneManager (zones+fat links)  |  40476/  875 | 37006/  722 |
|----------------------------------------+--------------+-------------|
| SystemClock                            |   8106/  405 |  4636/  252 |
| SystemClock+Basic TimeZone             |  12892/  577 |  9422/  424 |
| SystemClock+Extended TimeZone          |  15948/  611 | 12478/  458 |
+---------------------------------------------------------------------+

```

## SAMD21 M0 Mini

* 48 MHz ARM Cortex-M0+
* Arduino IDE 1.8.16, Arduino CLI 0.19.2
* Sparkfun SAMD Boards 1.8.4

```
+---------------------------------------------------------------------+
| Functionality                          |  flash/  ram |       delta |
|----------------------------------------+--------------+-------------|
| Baseline                               |  10064/    0 |     0/    0 |
|----------------------------------------+--------------+-------------|
| LocalDateTime                          |  10368/    0 |   304/    0 |
| ZonedDateTime                          |  10584/    0 |   520/    0 |
| Manual ZoneManager                     |  10608/    0 |   544/    0 |
| Basic TimeZone (1 zone)                |  14532/    0 |  4468/    0 |
| Basic TimeZone (2 zones)               |  14828/    0 |  4764/    0 |
| BasicZoneManager (1 zone)              |  15476/    0 |  5412/    0 |
| BasicZoneManager (zones)               |  32588/    0 | 22524/    0 |
| BasicZoneManager (zones+thin links)    |  34172/    0 | 24108/    0 |
| BasicZoneManager (zones+fat links)     |  39196/    0 | 29132/    0 |
| Extended TimeZone (1 zone)             |  16428/    0 |  6364/    0 |
| Extended TimeZone (2 zones)            |  16764/    0 |  6700/    0 |
| ExtendedZoneManager (1 zone)           |  17356/    0 |  7292/    0 |
| ExtendedZoneManager (zones)            |  46940/    0 | 36876/    0 |
| ExtendedZoneManager (zones+thin links) |  48716/    0 | 38652/    0 |
| ExtendedZoneManager (zones+fat links)  |  54380/    0 | 44316/    0 |
|----------------------------------------+--------------+-------------|
| SystemClock                            |  12944/    0 |  2880/    0 |
| SystemClock+Basic TimeZone             |  16572/    0 |  6508/    0 |
| SystemClock+Extended TimeZone          |  18596/    0 |  8532/    0 |
+---------------------------------------------------------------------+

```

(SAMD compiler does not produce RAM usage numbers.)

## STM32 Blue Pill

* STM32F103C8, 72 MHz ARM Cortex-M3
* Arduino IDE 1.8.16, Arduino CLI 0.19.2
* STM32duino 2.0.0

```
+---------------------------------------------------------------------+
| Functionality                          |  flash/  ram |       delta |
|----------------------------------------+--------------+-------------|
| Baseline                               |  21420/ 3536 |     0/    0 |
|----------------------------------------+--------------+-------------|
| LocalDateTime                          |  21604/ 3568 |   184/   32 |
| ZonedDateTime                          |  21772/ 3568 |   352/   32 |
| Manual ZoneManager                     |  21784/ 3568 |   364/   32 |
| Basic TimeZone (1 zone)                |  25624/ 3568 |  4204/   32 |
| Basic TimeZone (2 zones)               |  25888/ 3568 |  4468/   32 |
| BasicZoneManager (1 zone)              |  26472/ 3568 |  5052/   32 |
| BasicZoneManager (zones)               |  43348/ 3568 | 21928/   32 |
| BasicZoneManager (zones+thin links)    |  44924/ 3568 | 23504/   32 |
| BasicZoneManager (zones+fat links)     |  49792/ 3568 | 28372/   32 |
| Extended TimeZone (1 zone)             |  27288/ 3568 |  5868/   32 |
| Extended TimeZone (2 zones)            |  27596/ 3568 |  6176/   32 |
| ExtendedZoneManager (1 zone)           |  28212/ 3568 |  6792/   32 |
| ExtendedZoneManager (zones)            |  57388/ 3568 | 35968/   32 |
| ExtendedZoneManager (zones+thin links) |  59132/ 3568 | 37712/   32 |
| ExtendedZoneManager (zones+fat links)  |  64656/ 3568 | 43236/   32 |
|----------------------------------------+--------------+-------------|
| SystemClock                            |  28668/ 3768 |  7248/  232 |
| SystemClock+Basic TimeZone             |  32312/ 3768 | 10892/  232 |
| SystemClock+Extended TimeZone          |  34060/ 3768 | 12640/  232 |
+---------------------------------------------------------------------+

```

An entry of `-1` indicates that the memory usage exceeded the maximum of the
microcontroller and the compiler did not generate the desired information.

## ESP8266

* NodeMCU 1.0, 80MHz ESP8266
* Arduino IDE 1.8.16, Arduino CLI 0.19.2
* ESP8266 Boards 3.0.2

```
+---------------------------------------------------------------------+
| Functionality                          |  flash/  ram |       delta |
|----------------------------------------+--------------+-------------|
| Baseline                               | 260089/27892 |     0/    0 |
|----------------------------------------+--------------+-------------|
| LocalDateTime                          | 262597/27972 |  2508/   80 |
| ZonedDateTime                          | 262709/27972 |  2620/   80 |
| Manual ZoneManager                     | 262725/27972 |  2636/   80 |
| Basic TimeZone (1 zone)                | 268253/28548 |  8164/  656 |
| Basic TimeZone (2 zones)               | 268637/28548 |  8548/  656 |
| BasicZoneManager (1 zone)              | 269453/28548 |  9364/  656 |
| BasicZoneManager (zones)               | 286781/28548 | 26692/  656 |
| BasicZoneManager (zones+thin links)    | 288365/28548 | 28276/  656 |
| BasicZoneManager (zones+fat links)     | 293485/28548 | 33396/  656 |
| Extended TimeZone (1 zone)             | 270445/28692 | 10356/  800 |
| Extended TimeZone (2 zones)            | 270829/28692 | 10740/  800 |
| ExtendedZoneManager (1 zone)           | 271789/28692 | 11700/  800 |
| ExtendedZoneManager (zones)            | 301601/28688 | 41512/  796 |
| ExtendedZoneManager (zones+thin links) | 303345/28688 | 43256/  796 |
| ExtendedZoneManager (zones+fat links)  | 309169/28688 | 49080/  796 |
|----------------------------------------+--------------+-------------|
| SystemClock                            | 266341/28452 |  6252/  560 |
| SystemClock+Basic TimeZone             | 271633/29000 | 11544/ 1108 |
| SystemClock+Extended TimeZone          | 273825/29144 | 13736/ 1252 |
+---------------------------------------------------------------------+

```

## ESP32

* ESP32-01 Dev Board, 240 MHz Tensilica LX6
* Arduino IDE 1.8.16, Arduino CLI 0.19.2
* ESP32 Boards 1.0.6

```
+---------------------------------------------------------------------+
| Functionality                          |  flash/  ram |       delta |
|----------------------------------------+--------------+-------------|
| Baseline                               | 197748/13084 |     0/    0 |
|----------------------------------------+--------------+-------------|
| LocalDateTime                          | 206286/13432 |  8538/  348 |
| ZonedDateTime                          | 206426/13432 |  8678/  348 |
| Manual ZoneManager                     | 206486/13432 |  8738/  348 |
| Basic TimeZone (1 zone)                | 211026/13432 | 13278/  348 |
| Basic TimeZone (2 zones)               | 211410/13432 | 13662/  348 |
| BasicZoneManager (1 zone)              | 212098/13432 | 14350/  348 |
| BasicZoneManager (zones)               | 229414/13432 | 31666/  348 |
| BasicZoneManager (zones+thin links)    | 230986/13432 | 33238/  348 |
| BasicZoneManager (zones+fat links)     | 236118/13432 | 38370/  348 |
| Extended TimeZone (1 zone)             | 213038/13432 | 15290/  348 |
| Extended TimeZone (2 zones)            | 213410/13432 | 15662/  348 |
| ExtendedZoneManager (1 zone)           | 214130/13432 | 16382/  348 |
| ExtendedZoneManager (zones)            | 243990/13432 | 46242/  348 |
| ExtendedZoneManager (zones+thin links) | 245750/13432 | 48002/  348 |
| ExtendedZoneManager (zones+fat links)  | 251558/13432 | 53810/  348 |
|----------------------------------------+--------------+-------------|
| SystemClock                            | 217786/14304 | 20038/ 1220 |
| SystemClock+Basic TimeZone             | 222046/14304 | 24298/ 1220 |
| SystemClock+Extended TimeZone          | 224074/14304 | 26326/ 1220 |
+---------------------------------------------------------------------+

```

RAM usage remains constant as more objects are created, which indicates that an
initial pool of a certain minimum size is created regardless of the actual RAM
usage by objects.

## Teensy 3.2

* 96 MHz ARM Cortex-M4
* Arduino IDE 1.8.16, Arduino CLI 0.19.2
* Teensyduino 1.55

```
+---------------------------------------------------------------------+
| Functionality                          |  flash/  ram |       delta |
|----------------------------------------+--------------+-------------|
| Baseline                               |  10184/ 4152 |     0/    0 |
|----------------------------------------+--------------+-------------|
| LocalDateTime                          |  10308/ 4160 |   124/    8 |
| ZonedDateTime                          |  10308/ 4160 |   124/    8 |
| Manual ZoneManager                     |  10308/ 4160 |   124/    8 |
| Basic TimeZone (1 zone)                |  19328/ 4160 |  9144/    8 |
| Basic TimeZone (2 zones)               |  20056/ 4160 |  9872/    8 |
| BasicZoneManager (1 zone)              |  21420/ 4160 | 11236/    8 |
| BasicZoneManager (zones)               |  38752/ 4160 | 28568/    8 |
| BasicZoneManager (zones+thin links)    |  40296/ 4160 | 30112/    8 |
| BasicZoneManager (zones+fat links)     |  45456/ 4160 | 35272/    8 |
| Extended TimeZone (1 zone)             |  23148/ 4160 | 12964/    8 |
| Extended TimeZone (2 zones)            |  23876/ 4160 | 13692/    8 |
| ExtendedZoneManager (1 zone)           |  25240/ 4160 | 15056/    8 |
| ExtendedZoneManager (zones)            |  55112/ 4160 | 44928/    8 |
| ExtendedZoneManager (zones+thin links) |  56848/ 4160 | 46664/    8 |
| ExtendedZoneManager (zones+fat links)  |  62680/ 4160 | 52496/    8 |
|----------------------------------------+--------------+-------------|
| SystemClock                            |  16316/ 4820 |  6132/  668 |
| SystemClock+Basic TimeZone             |  25184/ 4820 | 15000/  668 |
| SystemClock+Extended TimeZone          |  29004/ 4820 | 18820/  668 |
+---------------------------------------------------------------------+

```

